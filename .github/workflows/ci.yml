name: CI Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  backend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend/crud-application
    steps:
      - uses: actions/checkout@v3
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
      - name: Build and test backend
        run: mvn clean test
      - name: Generate backend coverage
        run: mvn jacoco:report
      - name: Upload backend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: backend/crud-application/target/site/jacoco/jacoco.xml

      - name: Upload Backend Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: backend/crud-application/target/surefire-reports
          if-no-files-found: ignore

      - name: Upload Backend Coverage HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-coverage-html
          path: backend/crud-application/target/site/jacoco
          if-no-files-found: ignore

  frontend-test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend/crudfront
    steps:
      - uses: actions/checkout@v3
      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
      - name: Install dependencies
        run: npm install
      - name: Run frontend unit tests
        run: npm test -- --coverage --watchAll=false
      - name: Upload frontend coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: frontend/crudfront/coverage/lcov.info

      - name: Upload Frontend Coverage HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: frontend-coverage-html
          path: frontend/crudfront/coverage
          if-no-files-found: ignore

  e2e-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_DB: testdb
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"

      - name: Cache Cypress
        uses: actions/cache@v3
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('package-lock.json') }}

      - name: Install Cypress dependencies
        run: npm install

      - name: Start Backend Server
        working-directory: backend/crud-application
        run: |
          mvn clean install -DskipTests
          nohup mvn spring-boot:run > backend.log 2>&1 &
          echo $! > backend.pid
        env:
          SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
          SPRING_DATASOURCE_USERNAME: testuser
          SPRING_DATASOURCE_PASSWORD: testpass
          SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
          SPRING_JPA_HIBERNATE_DDL_AUTO: update

      - name: Wait for Backend
        run: |
          echo "Waiting for backend to start..."
          # Simple check: wait for port 8080 to be open
          timeout 120 bash -c 'until timeout 1 bash -c "echo > /dev/tcp/localhost/8080" 2>/dev/null; do sleep 2; done' || true
          # Give backend a few more seconds to fully initialize
          sleep 5
          echo "Backend should be ready now"

      - name: Install Frontend dependencies
        working-directory: frontend/crudfront
        run: npm install

      - name: Start Frontend Server
        working-directory: frontend/crudfront
        run: |
          npm start &
        env:
          CI: false

      - name: Wait for Frontend
        run: |
          timeout 120 bash -c 'until curl -f http://localhost:3000 2>/dev/null; do sleep 2; done' || true

      - name: Run Cypress E2E Tests
        run: |
          export NODE_OPTIONS="--no-warnings"
          npx cypress run --config baseUrl=http://localhost:3000
        continue-on-error: true

      - name: Upload E2E Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-screenshots
          path: cypress/screenshots
          if-no-files-found: ignore

      - name: Upload E2E Videos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-videos
          path: cypress/videos
          if-no-files-found: ignore

      - name: Upload E2E Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-test-reports
          path: cypress/results
          if-no-files-found: ignore

  deploy-coverage:
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test, e2e-tests]
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v3

      - name: Download Backend Coverage HTML
        uses: actions/download-artifact@v4
        with:
          name: backend-coverage-html
          path: ./public/coverage/backend

      - name: Download Frontend Coverage HTML
        uses: actions/download-artifact@v4
        with:
          name: frontend-coverage-html
          path: ./public/coverage/frontend

      - name: Create Coverage Index
        run: |
          mkdir -p ./public/coverage
          cat > ./public/coverage/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Test Coverage Reports</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 40px; }
              h1 { color: #333; }
              .coverage-links { margin-top: 20px; }
              .coverage-links a { 
                display: block; 
                padding: 15px; 
                margin: 10px 0; 
                background: #f0f0f0; 
                text-decoration: none; 
                color: #333;
                border-radius: 5px;
              }
              .coverage-links a:hover { background: #e0e0e0; }
            </style>
          </head>
          <body>
            <h1>ðŸ“Š Test Coverage Reports</h1>
            <div class="coverage-links">
              <a href="./backend/index.html">ðŸ”¹ Backend Coverage (JaCoCo)</a>
              <a href="./frontend/lcov-report/index.html">ðŸ”¹ Frontend Coverage (Jest)</a>
            </div>
          </body>
          </html>
          EOF

          cat > ./public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta http-equiv="refresh" content="0; url=./coverage/">
            <title>Redirecting to Coverage Reports</title>
          </head>
          <body>
            <p>Redirecting to <a href="./coverage/">Coverage Reports</a>...</p>
          </body>
          </html>
          EOF

      - name: Deploy Coverage to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          destination_dir: ./
